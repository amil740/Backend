using HRManagementApp.Interfaces;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Cryptography.X509Certificates;
using System.Text;
using System.Threading.Tasks;

namespace HRManagementApp.Models
{
    internal class Department : IHumanResourceManager
    {
        private string _name;
        private int _employeeLimit=1;
        private double _salaryLimit;
        public List<Employee> Employees { get; set; } = new List<Employee>();

        public static List<Department> Departments { get; set; } = new List<Department>();

        public double SalaryLimit
        {
            get => _salaryLimit;
            set
            {
                if (value < 250)
                {
                    throw new ArgumentException("Salary limit minimum 250 olmalidir");
                }
                _salaryLimit = value;
            }
        }
        public int EmployeeLimit 
        { 
            get => _employeeLimit; 
            set
            {
                if (value<1)
                {
                    throw new ArgumentException("Employee limit 1-den az ola bilmez");
                }
                _employeeLimit = value;
            }
        }
        public string Name 
        { 
            get => _name; 
            set
            {
                if (value.Length < 2)
                {
                    throw new ArgumentException("Department adi minimum 2 herf olmalidir");
                }
                _name = value;  
            }
        }

        public void AddDepartment(string name, int employeeLimit, double salaryLimit)
        {
            if(Departments.Any(d => d.Name.Equals(name, StringComparison.OrdinalIgnoreCase)))
            {
                throw new ArgumentException($"{name} adinda department artiq movcuddur");
            }
            Department department = new Department();
            department.Name = name;
            department.EmployeeLimit = employeeLimit;
            department.SalaryLimit = salaryLimit;
            Departments.Add(department);
        }

        public void AddEmployee(string fullName, string departmentName, string position, double salary)
        {
            if (Departments.Any(d => d.Employees.Any(e => e.FullName.Equals(fullName, StringComparison.OrdinalIgnoreCase))))
            {
                throw new ArgumentException($"{fullName} adinda isci artiq movcuddur");
            }
            Department department = Departments.FirstOrDefault(d => d.Name.Equals(departmentName, StringComparison.OrdinalIgnoreCase));
            if (department == null)
            {
                throw new ArgumentException($"{departmentName} adinda department tapilmadi");
            }
            
            if (department.Employees.Count >= department.EmployeeLimit)
            {
                throw new ArgumentException($"{department.Name} departmentinde isci limiti dolub");
            }
            
            double totalSalary = department.Employees.Sum(e => e.Salary);
            if (totalSalary + salary > department.SalaryLimit)
            {
                throw new ArgumentException($"{department.Name} departmentinde maas limiti asilir");
            }
            Employee employee = new Employee(fullName, departmentName, position, salary);
            department.Employees.Add(employee);
        }

        public void EditDepartment(string name, int newEmployeeLimit, double newSalaryLimit)
        {
            Department department = Departments.FirstOrDefault(d => 
                d.Name.Equals(name, StringComparison.OrdinalIgnoreCase));

            if (department == null)
            {
                throw new ArgumentException($"{name} adinda department tapilmadi");
            }
            
            if (newEmployeeLimit < department.Employees.Count)
            {
                throw new ArgumentException("Yeni employee limiti movcud iscilerden az ola bilmez");
            }
            
            double totalSalary = department.Employees.Sum(e => e.Salary);
            if (newSalaryLimit < totalSalary)
            {
                throw new ArgumentException("Yeni maas limiti movcud umumi maasdan az ola bilmez");
            }
            
            department.EmployeeLimit = newEmployeeLimit;
            department.SalaryLimit = newSalaryLimit;
        }

        public void EditEmployee(string no, string newPosition, double newSalary)
        {
            foreach (var department in Departments)
            {
                var employee = department.Employees.FirstOrDefault(e => e.No.Equals(no, StringComparison.OrdinalIgnoreCase));
                
                if (employee != null)
                {
                    double currentTotalSalary = department.Employees.Sum(e => e.Salary);
                    double newTotalSalary = currentTotalSalary - employee.Salary + newSalary;
                    
                    if (newTotalSalary > department.SalaryLimit)
                    {
                        throw new ArgumentException($"{department.Name} departmentinde maas limiti asilir");
                    }
                    
                    employee.Position = newPosition;
                    employee.Salary = newSalary;
                    return;
                }
            }
            
            throw new ArgumentException($"{no} nomreli isci tapilmadi");
        }

        public void GetAllEmployees()
        {
            public override string ToString()
            {
            return $"No: {No}, FullName: {FullName}, Department: {DepartmentName}, Position: {Position}, Salary: {Salary}";
            }
        }

        public void RemoveEmployee(string no)
        {
            foreach (var department in Departments)
            {
                var employee = department.Employees.FirstOrDefault(e => e.No.Equals(no, StringComparison.OrdinalIgnoreCase));
                
                if (employee != null)
                {
                    department.Employees.Remove(employee);
                    return;
                }
            }
            
            throw new ArgumentException($"{no} nomreli isci tapilmadi");
        }

        public void SearchEmployee(string search)
        {
            var foundEmployees = Departments
                .SelectMany(d => d.Employees)
                .Where(e => e.FullName.Contains(search, StringComparison.OrdinalIgnoreCase))
                .ToList();

            if (!foundEmployees.Any())
            {
                Console.WriteLine($"{search} ile esleshen isci tapilmadi");
                return;
            }

            foreach (var employee in foundEmployees)
            {
                Console.WriteLine($"No: {employee.No}, FullName: {employee.FullName}, Department: {employee.DepartmentName}, Position: {employee.Position}, Salary: {employee.Salary}");
            }
        }

        public void GetAllDepartments()
        {
           throw new NotImplementedException();
        }

        public void RemoveDepartment(string name)
        {
           throw new NotImplementedException();
        }
    }
}
