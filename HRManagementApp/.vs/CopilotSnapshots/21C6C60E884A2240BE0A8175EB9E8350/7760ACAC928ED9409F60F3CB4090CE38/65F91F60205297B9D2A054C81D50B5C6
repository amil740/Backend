using HRManagementApp.Interfaces;
using HRManagementApp.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Newtonsoft.Json;

namespace HRManagementApp.Services
{
    internal class HumanResourceManagerService : IHumanResourceManager
    {
        private const string JsonFilePath = "hrdata.json";
        public List<Department> Departments { get; private set; } = new List<Department>();

        public HumanResourceManagerService()
        {
            LoadFromJson();
        }

        private void LoadFromJson()
        {
            try
            {
                if (File.Exists(JsonFilePath))
                {
                    string json = File.ReadAllText(JsonFilePath);
                    Departments = JsonConvert.DeserializeObject<List<Department>>(json) ?? new List<Department>();
                    Console.WriteLine("Melumatlari JSON fayldan yukledim.");
                }
                else
                {
                    Console.WriteLine("JSON fayl tapilmadi. Yeni fayl yaradilacaq.");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"JSON yukleme xetasi: {ex.Message}");
                Departments = new List<Department>();
            }
        }

        private void SaveToJson()
        {
            try
            {
                string json = JsonConvert.SerializeObject(Departments, Formatting.Indented);
                File.WriteAllText(JsonFilePath, json);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"JSON saxlama xetasi: {ex.Message}");
            }
        }

        public void AddDepartment(string name, int employeeLimit, double salaryLimit)
        {
            if (Departments.Any(d => d.Name.Equals(name, StringComparison.OrdinalIgnoreCase)))
            {
                throw new ArgumentException($"{name} adinda department artiq movcuddur");
            }
            Department department = new Department();
            department.Name = name;
            department.EmployeeLimit = employeeLimit;
            department.SalaryLimit = salaryLimit;
            Departments.Add(department);
            SaveToJson();
        }

        public void AddEmployee(string fullName, string departmentName, string position, double salary)
        {
            if (Departments.Any(d => d.Employees.Any(e => e.FullName.Equals(fullName, StringComparison.OrdinalIgnoreCase))))
            {
                throw new ArgumentException($"{fullName} adinda isci artiq movcuddur");
            }
            Department department = Departments.FirstOrDefault(d => d.Name.Equals(departmentName, StringComparison.OrdinalIgnoreCase));
            if (department == null)
            {
                throw new ArgumentException($"{departmentName} adinda department tapilmadi");
            }

            if (department.Employees.Count >= department.EmployeeLimit)
            {
                throw new ArgumentException($"{department.Name} departmentinde isci limiti dolub");
            }

            double totalSalary = department.Employees.Sum(e => e.Salary);
            if (totalSalary + salary > department.SalaryLimit)
            {
                throw new ArgumentException($"{department.Name} departmentinde maas limiti asilir");
            }
            Employee employee = new Employee(fullName, departmentName, position, salary);
            department.Employees.Add(employee);
            SaveToJson();
        }

        public void EditDepartment(string name, int newEmployeeLimit, double newSalaryLimit)
        {
            Department department = Departments.FirstOrDefault(d => d.Name.Equals(name, StringComparison.OrdinalIgnoreCase));

            if (department == null)
            {
                throw new ArgumentException($"{name} adinda department tapilmadi");
            }

            if (newEmployeeLimit < department.Employees.Count)
            {
                throw new ArgumentException("Yeni employee limiti movcud iscilerden az ola bilmez");
            }

            double totalSalary = department.Employees.Sum(e => e.Salary);
            if (newSalaryLimit < totalSalary)
            {
                throw new ArgumentException("Yeni maas limiti movcud umumi maasdan az ola bilmez");
            }

            department.EmployeeLimit = newEmployeeLimit;
            department.SalaryLimit = newSalaryLimit;
            SaveToJson();
        }

        public void EditEmployee(string no, string newPosition, double newSalary)
        {
            foreach (var department in Departments)
            {
                var employee = department.Employees.FirstOrDefault(e => e.No.Equals(no, StringComparison.OrdinalIgnoreCase));

                if (employee != null)
                {
                    double currentTotalSalary = department.Employees.Sum(e => e.Salary);
                    double newTotalSalary = currentTotalSalary - employee.Salary + newSalary;

                    if (newTotalSalary > department.SalaryLimit)
                    {
                        throw new ArgumentException($"{department.Name} departmentinde maas limiti asilir");
                    }

                    employee.Position = newPosition;
                    employee.Salary = newSalary;
                    SaveToJson();
                    return;
                }
            }

            throw new ArgumentException($"{no} nomreli isci tapilmadi");
        }

        public void GetAllEmployees()
        {
            if (!Departments.Any())
            {
                Console.WriteLine("Hec bir department movcud deyil");
                return;
            }

            foreach (var department in Departments)
            {
                Console.WriteLine($"{department.Name} Departamenti:");

                if (!department.Employees.Any())
                {
                    Console.WriteLine("Isci yoxdur");
                }
                else
                {
                    foreach (var employee in department.Employees)
                    {
                        Console.WriteLine($"  No: {employee.No}, FullName: {employee.FullName}, Position: {employee.Position}, Salary: {employee.Salary}");
                    }
                }
            }
        }

        public void GetAllDepartments()
        {
            if (!Departments.Any())
            {
                Console.WriteLine("Hec bir department movcud deyil");
                return;
            }

            foreach (var department in Departments)
            {
                double totalSalary = department.Employees.Sum(e => e.Salary);
                Console.WriteLine($"Department: {department.Name}, Employee Limit: {department.EmployeeLimit}, Employee Count: {department.Employees.Count}, Salary Limit: {department.SalaryLimit}, Total Salary: {totalSalary}");
            }
        }

        public void RemoveDepartment(string name)
        {
            Department department = Departments.FirstOrDefault(d => d.Name.Equals(name, StringComparison.OrdinalIgnoreCase));

            if (department == null)
            {
                throw new ArgumentException($"{name} adinda department tapilmadi");
            }

            if (department.Employees.Any())
            {
                throw new ArgumentException($"{department.Name} departmentinde isciler var, evvelce onlari silmek lazimdir");
            }

            Departments.Remove(department);
            SaveToJson();
        }

        public void RemoveEmployee(string no)
        {
            foreach (var department in Departments)
            {
                var employee = department.Employees.FirstOrDefault(e => e.No.Equals(no, StringComparison.OrdinalIgnoreCase));

                if (employee != null)
                {
                    department.Employees.Remove(employee);
                    SaveToJson();
                    return;
                }
            }

            throw new ArgumentException($"{no} nomreli isci tapilmadi");
        }

        public void SearchEmployee(string search)
        {
            List<Employee> foundEmployees = Departments.SelectMany(d => d.Employees).Where(e => e.FullName.Contains(search, StringComparison.OrdinalIgnoreCase)).ToList();

            if (!foundEmployees.Any())
            {
                Console.WriteLine($"{search} ile esleshen isci tapilmadi");
                return;
            }

            foreach (var employee in foundEmployees)
            {
                Console.WriteLine($"No: {employee.No}, FullName: {employee.FullName}, Department: {employee.DepartmentName}, Position: {employee.Position}, Salary: {employee.Salary}");
            }
        }
    }
}
