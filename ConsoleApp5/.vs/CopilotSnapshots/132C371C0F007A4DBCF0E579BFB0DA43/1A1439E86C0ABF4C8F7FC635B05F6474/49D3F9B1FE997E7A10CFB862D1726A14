using Microsoft.AspNetCore.Mvc;
using System.Text;
using System.Text.Json;

namespace ConsoleApp5.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class AIController : ControllerBase
    {
        private readonly IHttpClientFactory _httpClientFactory;
        private readonly IConfiguration _configuration;

        public AIController(IHttpClientFactory httpClientFactory, IConfiguration configuration)
        {
            _httpClientFactory = httpClientFactory;
            _configuration = configuration;
        }

        [HttpPost("generate-image")]
        public async Task<IActionResult> GenerateImage([FromBody] ImageRequest request)
        {
            try
            {
                var apiKey = _configuration["OpenAI:ApiKey"] ?? "your-api-key-here";
                var client = _httpClientFactory.CreateClient();
                client.DefaultRequestHeaders.Add("Authorization", $"Bearer {apiKey}");

                var payload = new
                {
                    model = "dall-e-3",
                    prompt = request.Prompt,
                    n = 1,
                    size = request.Size ?? "1024x1024",
                    quality = "hd"
                };

                var content = new StringContent(
                    JsonSerializer.Serialize(payload),
                    Encoding.UTF8,
                    "application/json"
                );

                var response = await client.PostAsync(
                    "https://api.openai.com/v1/images/generations",
                    content
                );

                var responseContent = await response.Content.ReadAsStringAsync();

                if (response.IsSuccessStatusCode)
                {
                    return Ok(JsonSerializer.Deserialize<object>(responseContent));
                }

                return BadRequest(new { error = "Failed to generate image", details = responseContent });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { error = ex.Message });
            }
        }

        [HttpPost("generate-video")]
        public async Task<IActionResult> GenerateVideo([FromBody] VideoRequest request)
        {
            try
            {
                // This is a placeholder for video generation
                // You can integrate with services like Runway ML, Stability AI, or other video generation APIs
                var apiKey = _configuration["VideoAPI:ApiKey"] ?? "your-video-api-key";
                
                // Simulated response for now
                await Task.Delay(1000);
                
                return Ok(new
                {
                    status = "processing",
                    message = "Video generation started. This typically takes 1-5 minutes.",
                    videoId = Guid.NewGuid().ToString(),
                    prompt = request.Prompt,
                    estimatedTime = "3-5 minutes"
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { error = ex.Message });
            }
        }

        [HttpPost("chat")]
        public async Task<IActionResult> Chat([FromBody] ChatRequest request)
        {
            try
            {
                var apiKey = _configuration["OpenAI:ApiKey"] ?? "your-api-key-here";
                var client = _httpClientFactory.CreateClient();
                client.DefaultRequestHeaders.Add("Authorization", $"Bearer {apiKey}");

                var payload = new
                {
                    model = "gpt-4",
                    messages = request.Messages,
                    temperature = 0.7,
                    max_tokens = 2000
                };

                var content = new StringContent(
                    JsonSerializer.Serialize(payload),
                    Encoding.UTF8,
                    "application/json"
                );

                var response = await client.PostAsync(
                    "https://api.openai.com/v1/chat/completions",
                    content
                );

                var responseContent = await response.Content.ReadAsStringAsync();

                if (response.IsSuccessStatusCode)
                {
                    return Ok(JsonSerializer.Deserialize<object>(responseContent));
                }

                return BadRequest(new { error = "Failed to get response", details = responseContent });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { error = ex.Message });
            }
        }
    }

    public class ImageRequest
    {
        public string Prompt { get; set; } = string.Empty;
        public string? Size { get; set; }
    }

    public class VideoRequest
    {
        public string Prompt { get; set; } = string.Empty;
        public int? Duration { get; set; }
    }

    public class ChatRequest
    {
        public List<ChatMessage> Messages { get; set; } = new();
    }

    public class ChatMessage
    {
        public string Role { get; set; } = string.Empty;
        public string Content { get; set; } = string.Empty;
    }
}
