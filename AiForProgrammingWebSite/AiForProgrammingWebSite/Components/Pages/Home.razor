@page "/"
@using AiForProgrammingWebSite.Models
@using AiForProgrammingWebSite.Services
@inject AiCodingAssistantService AiService
@rendermode InteractiveServer

<PageTitle>AI Programming Assistant</PageTitle>

<div class="max-w-7xl mx-auto">
    <!-- Header Section -->
    <div class="text-center mb-12">
        <h1 class="text-5xl font-bold mb-4 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent">
            Advanced AI Programming Assistant
        </h1>
        <p class="text-xl text-gray-400">
            Analyze, refactor, debug, and improve your code with cutting-edge AI technology
        </p>
    </div>

    <!-- Features Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        <div class="bg-gray-900/50 backdrop-blur-lg rounded-xl p-6 border border-gray-800 hover:border-blue-500 transition">
            <div class="text-4xl mb-4">🔍</div>
            <h3 class="text-xl font-bold mb-2 text-blue-400">Code Analysis</h3>
            <p class="text-gray-400">Deep analysis of your code for bugs, performance issues, and best practices</p>
        </div>
        <div class="bg-gray-900/50 backdrop-blur-lg rounded-xl p-6 border border-gray-800 hover:border-purple-500 transition">
            <div class="text-4xl mb-4">🔧</div>
            <h3 class="text-xl font-bold mb-2 text-purple-400">Smart Refactoring</h3>
            <p class="text-gray-400">Automatic code refactoring following SOLID principles and best practices</p>
        </div>
        <div class="bg-gray-900/50 backdrop-blur-lg rounded-xl p-6 border border-gray-800 hover:border-pink-500 transition">
            <div class="text-4xl mb-4">🐛</div>
            <h3 class="text-xl font-bold mb-2 text-pink-400">Bug Detection</h3>
            <p class="text-gray-400">Intelligent bug detection with suggested fixes and explanations</p>
        </div>
    </div>

    <!-- Main Workspace -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Input Section -->
        <div class="bg-gray-900/50 backdrop-blur-lg rounded-xl border border-gray-800 overflow-hidden">
            <div class="bg-gray-800/50 px-6 py-4 border-b border-gray-700">
                <h2 class="text-xl font-bold text-blue-400">Your Code</h2>
            </div>
            <div class="p-6">
                <!-- Language Selector -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2 text-gray-300">Programming Language</label>
                    <select @bind="selectedLanguage" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="csharp">C#</option>
                        <option value="python">Python</option>
                        <option value="javascript">JavaScript</option>
                        <option value="typescript">TypeScript</option>
                        <option value="java">Java</option>
                        <option value="cpp">C++</option>
                        <option value="go">Go</option>
                        <option value="rust">Rust</option>
                    </select>
                </div>

                <!-- Task Selector -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2 text-gray-300">AI Task</label>
                    <div class="grid grid-cols-2 gap-2">
                        @foreach (var task in tasks)
                        {
                            <button @onclick="() => selectedTask = task.Key"
                                    class="px-4 py-2 rounded-lg font-medium transition @(selectedTask == task.Key ? "bg-blue-600 text-white" : "bg-gray-800 text-gray-300 hover:bg-gray-700")">
                                @task.Value
                            </button>
                        }
                    </div>
                </div>

                <!-- Code Input -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2 text-gray-300">Code Input</label>
                    <textarea @bind="codeInput"
                              class="w-full h-96 bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                              placeholder="Paste your code here..."></textarea>
                </div>

                <!-- Action Button -->
                <button @onclick="ProcessCode"
                        disabled="@isProcessing"
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 disabled:from-gray-700 disabled:to-gray-700 text-white font-bold py-3 px-6 rounded-lg transition transform hover:scale-105 disabled:scale-100 disabled:cursor-not-allowed">
                    @if (isProcessing)
                    {
                        <span>⏳ Processing...</span>
                    }
                    else
                    {
                        <span>✨ Analyze Code</span>
                    }
                </button>
            </div>
        </div>

        <!-- Output Section -->
        <div class="bg-gray-900/50 backdrop-blur-lg rounded-xl border border-gray-800 overflow-hidden">
            <div class="bg-gray-800/50 px-6 py-4 border-b border-gray-700 flex items-center justify-between">
                <h2 class="text-xl font-bold text-purple-400">AI Analysis Results</h2>
                @if (result?.Success == true)
                {
                    <button @onclick="CopyToClipboard"
                            class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition">
                        📋 Copy
                    </button>
                }
            </div>
            <div class="p-6 overflow-y-auto max-h-[800px]">
                @if (result == null)
                {
                    <div class="text-center text-gray-500 py-12">
                        <div class="text-6xl mb-4">🤖</div>
                        <p class="text-lg">Enter your code and click "Analyze Code" to get started</p>
                    </div>
                }
                else if (!result.Success)
                {
                    <div class="bg-red-900/20 border border-red-800 rounded-lg p-4 text-red-400">
                        <strong>Error:</strong> @result.ErrorMessage
                    </div>
                }
                else
                {
                    <!-- Explanation -->
                    @if (!string.IsNullOrEmpty(result.Explanation))
                    {
                        <div class="mb-6">
                            <h3 class="text-lg font-bold mb-3 text-blue-400">📝 Explanation</h3>
                            <div class="bg-gray-800/50 rounded-lg p-4 text-gray-300">
                                @result.Explanation
                            </div>
                        </div>
                    }

                    <!-- Issues -->
                    @if (result.Issues?.Any() == true)
                    {
                        <div class="mb-6">
                            <h3 class="text-lg font-bold mb-3 text-red-400">🐛 Issues Found</h3>
                            @foreach (var issue in result.Issues)
                            {
                                <div class="bg-gray-800/50 rounded-lg p-4 mb-3 border-l-4 @GetSeverityColor(issue.Severity)">
                                    <div class="flex items-start justify-between">
                                        <div>
                                            <div class="font-bold text-white mb-1">@issue.Type</div>
                                            <div class="text-sm text-gray-400 mb-2">Line @issue.Line • @issue.Severity</div>
                                            <div class="text-gray-300">@issue.Message</div>
                                            @if (!string.IsNullOrEmpty(issue.SuggestedFix))
                                            {
                                                <div class="mt-2 text-sm text-green-400">
                                                    💡 Fix: @issue.SuggestedFix
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    <!-- Suggestions -->
                    @if (result.Suggestions?.Any() == true)
                    {
                        <div class="mb-6">
                            <h3 class="text-lg font-bold mb-3 text-yellow-400">💡 Suggestions</h3>
                            @foreach (var suggestion in result.Suggestions)
                            {
                                <div class="bg-gray-800/50 rounded-lg p-4 mb-3 border-l-4 border-yellow-500">
                                    <div class="font-bold text-white mb-1">@suggestion.Title</div>
                                    <div class="text-sm text-gray-400 mb-2">@suggestion.Category • @suggestion.Severity</div>
                                    <div class="text-gray-300">@suggestion.Description</div>
                                </div>
                            }
                        </div>
                    }

                    <!-- Processed Code -->
                    @if (!string.IsNullOrEmpty(result.ProcessedCode) && result.ProcessedCode != result.OriginalCode)
                    {
                        <div class="mb-6">
                            <h3 class="text-lg font-bold mb-3 text-green-400">✨ Improved Code</h3>
                            <div class="bg-gray-800 rounded-lg p-4 overflow-x-auto">
                                <pre><code class="language-@selectedLanguage text-sm">@result.ProcessedCode</code></pre>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <!-- Statistics -->
    @if (result?.Success == true)
    {
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-12">
            <div class="bg-gray-900/50 backdrop-blur-lg rounded-xl p-6 border border-gray-800 text-center">
                <div class="text-3xl font-bold text-blue-400">@(result.Issues?.Count ?? 0)</div>
                <div class="text-gray-400 mt-2">Issues Found</div>
            </div>
            <div class="bg-gray-900/50 backdrop-blur-lg rounded-xl p-6 border border-gray-800 text-center">
                <div class="text-3xl font-bold text-purple-400">@(result.Suggestions?.Count ?? 0)</div>
                <div class="text-gray-400 mt-2">Suggestions</div>
            </div>
            <div class="bg-gray-900/50 backdrop-blur-lg rounded-xl p-6 border border-gray-800 text-center">
                <div class="text-3xl font-bold text-green-400">@codeInput.Split('\n').Length</div>
                <div class="text-gray-400 mt-2">Lines of Code</div>
            </div>
            <div class="bg-gray-900/50 backdrop-blur-lg rounded-xl p-6 border border-gray-800 text-center">
                <div class="text-3xl font-bold text-pink-400">@selectedLanguage.ToUpper()</div>
                <div class="text-gray-400 mt-2">Language</div>
            </div>
        </div>
    }
</div>

@code {
    private string codeInput = @"public class Calculator
{
    public int Add(int a, int b)
    {
        return a + b;
    }
    
    public int Divide(int a, int b)
    {
        return a / b; // Bug: No zero check!
    }
}";
    
    private string selectedLanguage = "csharp";
    private string selectedTask = "analyze";
    private bool isProcessing = false;
    private CodeAnalysisResponse? result = null;

    private Dictionary<string, string> tasks = new()
    {
        { "analyze", "🔍 Analyze" },
        { "refactor", "🔧 Refactor" },
        { "debug", "🐛 Debug" },
        { "complete", "✨ Complete" },
        { "explain", "📖 Explain" }
    };

    private async Task ProcessCode()
    {
        if (string.IsNullOrWhiteSpace(codeInput))
            return;

        isProcessing = true;
        result = null;

        try
        {
            var request = new CodeAnalysisRequest
            {
                Code = codeInput,
                Language = selectedLanguage,
                Task = selectedTask
            };

            result = await AiService.AnalyzeCodeAsync(request);
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void CopyToClipboard()
    {

    }

    private string GetSeverityColor(string severity)
    {
        return severity.ToLower() switch
        {
            "error" => "border-red-500",
            "warning" => "border-yellow-500",
            _ => "border-blue-500"
        };
    }
}
